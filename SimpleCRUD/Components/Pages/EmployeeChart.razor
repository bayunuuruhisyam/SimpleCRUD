@page "/employee-chart"
@using SimpleCRUD.Services
@inject EmployeeService EmployeeService

<MudContainer MaxWidth="MaxWidth.False" Class="mt-4">

    <!-- ===== SUMMARY ===== -->
    <MudGrid GutterSize="3">
        <MudItem xs="12" md="4">
            <MudPaper Elevation="3" Class="pa-4">
                <MudText Typo="Typo.subtitle2">Total Department</MudText>
                <MudText Typo="Typo.h4">@TotalDepartment</MudText>
            </MudPaper>
        </MudItem>

        <MudItem xs="12" md="4">
            <MudPaper Elevation="3" Class="pa-4">
                <MudText Typo="Typo.subtitle2">Total Employee</MudText>
                <MudText Typo="Typo.h4">@TotalEmployee</MudText>
            </MudPaper>
        </MudItem>

        <MudItem xs="12" md="4">
            <MudPaper Elevation="3" Class="pa-4">
                <MudText Typo="Typo.subtitle2">Average Age (Overall)</MudText>
                <MudText Typo="Typo.h4">@AverageAgeOverall</MudText>
            </MudPaper>
        </MudItem>
    </MudGrid>

    <!-- ===== CHART ===== -->
    <MudGrid GutterSize="3" Class="mt-4">

        <!-- BAR CHART -->
        <MudItem xs="12" md="8">
            <MudPaper Elevation="3" Class="pa-4">
                <MudText Typo="Typo.h6" Class="mb-2">
                    Average Age per Department
                </MudText>

                <MudChart ChartType="ChartType.Bar"
                          ChartSeries="@BarSeries"
                          XAxisLabels="@DepartmentLabels"
                          Width="100%"
                          Height="400px" />
            </MudPaper>
        </MudItem>

        <!-- PIE CHART -->
        <MudItem xs="12" md="4">
            <MudPaper Elevation="3" Class="pa-4">
                <MudText Typo="Typo.h6" Class="mb-2">
                    Age Distribution (Average)
                </MudText>

                <MudChart ChartType="ChartType.Pie"
                          Labels="@DepartmentLabels"
                          Data="@PieData"
                          Width="100%"
                          Height="400px" />
            </MudPaper>
        </MudItem>

    </MudGrid>
</MudContainer>

@code {
    // ===== SUMMARY =====
    int TotalDepartment;
    int TotalEmployee;
    int AverageAgeOverall;

    // ===== CHART DATA =====
    List<ChartSeries> BarSeries = new();
    string[] DepartmentLabels = Array.Empty<string>();
    double[] PieData = Array.Empty<double>();

    protected override async Task OnInitializedAsync()
    {
        // ambil semua employee
        var employees = await EmployeeService.GetAllEmployees();

        // group by department + average age
        var avgAgePerDept = employees
            .GroupBy(e => e.Department)
            .Select(g => new
            {
                Department = g.Key,
                AvgAge = g.Average(x => x.Age),
                Count = g.Count()
            })
            .OrderByDescending(x => x.AvgAge)
            .Take(8) // biar ga rame
            .ToList();

        // SUMMARY
        TotalDepartment = employees.Select(x => x.Department).Distinct().Count();
        TotalEmployee = employees.Count;
        AverageAgeOverall = TotalEmployee == 0
            ? 0
            : (int)employees.Average(x => x.Age);

        // LABEL
        DepartmentLabels = avgAgePerDept.Select(x => x.Department).ToArray();

        // BAR
        BarSeries.Add(new ChartSeries
        {
            Name = "Average Age",
            Data = avgAgePerDept.Select(x => Math.Round(x.AvgAge, 1)).ToArray()
        });

        // PIE
        PieData = avgAgePerDept.Select(x => Math.Round(x.AvgAge, 1)).ToArray();
    }
}
