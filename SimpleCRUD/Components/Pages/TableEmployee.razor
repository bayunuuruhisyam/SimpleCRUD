@page "/tableemployee"

@rendermode InteractiveServer
@using Microsoft.EntityFrameworkCore
@using SimpleCRUD.DataAccess.Entities
@using SimpleCRUD.Enum
@using SimpleCRUD.Services
@using SimpleCRUD.ViewModels

@inject EmployeeService EmployeeService
@inject IDialogService DialogService
@inject ISnackbar Snackbar


<MudContainer MaxWidth="MaxWidth.Large" Class="mt-4">

    <PageTitle>Table Employee</PageTitle>

    <h2>
        Table Employee
    </h2>


    <MudDataGrid @ref="dataGrid"
                 T="EmployeeViewModel"
                 ServerData="ServerReload"
                 Filterable="false"
                 Dense="true"
                 Hover="true"
                 Bordered="true"
                 Class="border-black">

        <!-- TOOLBAR -->
        <ToolBarContent>
            <MudButton StartIcon="@Icons.Material.Filled.PersonAddAlt1"
                       Color="Color.Primary"
                       Variant="Variant.Filled"
                       Class="me-3"
                       OnClick="CreateNewUser">
                Create Employee
            </MudButton>

            <MudButton StartIcon="@Icons.Material.Filled.FilterAlt"
                       Color="Color.Secondary"
                       Variant="Variant.Filled"
                       OnClick="OpenFilterDialog">
                Filter
            </MudButton>

        </ToolBarContent>


        <!-- COLUMNS -->
        <Columns>
            <PropertyColumn Property="x => x.EmployeeIdView"
                            Title="Employee ID" />

            <TemplateColumn Title="Full Name" SortBy="x => x.FullName">
                <CellTemplate>
                    <MudLink Class="  " Href="@($"/employee/{context.Item.EmployeeId}")">
                        @context.Item.FullName
                    </MudLink>
                </CellTemplate>
            </TemplateColumn>

            <PropertyColumn Property="x => x.Department"
                            Title="Department"
                            Sortable="false">
                <CellTemplate>
                    <MudChip Size="Size.Small"
                             Variant="Variant.Outlined"
                             Color="Color.Info">
                        @context.Item.Department
                    </MudChip>
                </CellTemplate>
            </PropertyColumn>

            <PropertyColumn Property="x => x.DateOfBirth"
                            Title="Date of Birth"
                            Format="dd MMM yyyy"
                            Sortable="false" />

            <PropertyColumn Property="x => x.Age"
                            Title="Age">
                <CellTemplate>
                    <MudText Color="Color.Secondary">
                        @context.Item.Age th
                    </MudText>
                </CellTemplate>
            </PropertyColumn>

            <PropertyColumn Property="x => x.PhoneNumber"
                            Title="Phone Number"
                            Sortable="false" />
           
            <TemplateColumn Title="Status">
                <CellTemplate Context="context">

                    <MudChip T="string"
                             Style="cursor:pointer"
                             Variant="Variant.Filled"
                             Disabled="@(loadingId == context.Item.EmployeeId)"
                             Color="@(context.Item.IsActive ? Color.Success : Color.Error)"
                             OnClick="@(async () => await ToggleStatus(context.Item.EmployeeId))">

                        @(loadingId == context.Item.EmployeeId 
                            ? "Updating..." 
                            : (context.Item.IsActive ? "Active" : "Inactive"))

                    </MudChip>

                </CellTemplate>
            </TemplateColumn>

            <!-- Update & Delete -->
            <TemplateColumn Title="Action">
                <CellTemplate>


                    <MudButton Class="my-2"
                               Size="@Size.Small"
                               Variant="Variant.Filled"
                               StartIcon="@Icons.Material.Filled.Edit"
                               Color="@Color.Warning"
                               OnClick="@(() => this.UpdateEmployee(context))">
                        Update
                    </MudButton>

                    <MudButton Size="@Size.Small"
                               Variant="Variant.Filled"
                               StartIcon="@Icons.Material.Filled.Delete"
                               Color="@Color.Error"
                               OnClick="@(() => this.RemoveEmployee(context))">
                        Remove
                    </MudButton>

                </CellTemplate>
            </TemplateColumn>
        </Columns>


        <!-- PAGER -->
        <PagerContent>
            <MudDataGridPager T="EmployeeViewModel"
                              PageSizeOptions="new int[] { 5, 10, 20 }" />
        </PagerContent>

    </MudDataGrid>

</MudContainer>

@code {

    MudDataGrid<EmployeeViewModel> dataGrid;
    private List<EmployeeViewModel> employees;

    // ===== FILTER STATE =====
    private string? searchString;
    private string? selectedDepartment;
    private int? minAge;
    private int? maxAge;

    // contoh static department
    private IEnumerable<string> Departments = Enumerable.Empty<string>();

    protected override async Task OnInitializedAsync()
    {
        await LoadDepartments();
    }

    private async Task LoadDepartments()
    {
        var employees = await EmployeeService.GetAllEmployees();

        Departments = employees
            .Select(e => e.Department)
            .Where(d => !string.IsNullOrWhiteSpace(d))
            .Distinct(StringComparer.OrdinalIgnoreCase)
            .OrderBy(d => d)
            .ToList();
    }

    private async Task<GridData<EmployeeViewModel>> ServerReload(GridState<EmployeeViewModel> state)
    {
        IEnumerable<EmployeeViewModel> data = await EmployeeService.GetAllEmployees();
        data = data.Where(MatchFilter);

        var totalItems = data.Count();


        // SORT
        var sort = state.SortDefinitions.FirstOrDefault();
        if (sort != null)
        {
            data = sort.SortBy switch
            {
                nameof(EmployeeViewModel.EmployeeIdView)
                    => data.OrderByDirection(sort.Descending ? SortDirection.Descending : SortDirection.Ascending, x => x.EmployeeIdView),

                nameof(EmployeeViewModel.Age)
                    => data.OrderByDirection(sort.Descending ? SortDirection.Descending : SortDirection.Ascending, x => x.Age),

            };
        }

        // PAGING
        data = data
            .Skip(state.Page * state.PageSize)
            .Take(state.PageSize);

        return new GridData<EmployeeViewModel>
        {
            TotalItems = totalItems,
            Items = data.ToArray()
        };
    }

    // FILTER CORE
    private bool MatchFilter(EmployeeViewModel e)
    {
        // SEARCH (ID + NAME)
        if (!string.IsNullOrWhiteSpace(searchString))
        {
            if (!e.FullName.Contains(searchString, StringComparison.OrdinalIgnoreCase) &&
                !e.EmployeeIdView.Contains(searchString, StringComparison.OrdinalIgnoreCase))
                return false;
        }

        // DEPARTMENT
        if (!string.IsNullOrWhiteSpace(selectedDepartment) &&
            !string.Equals(e.Department, selectedDepartment, StringComparison.OrdinalIgnoreCase))
            return false;

        // AGE
        if (minAge.HasValue && e.Age < minAge.Value)
            return false;

        if (maxAge.HasValue && e.Age > maxAge.Value)
            return false;

        return true;
    }

    // ===== FILTER HANDLER (SEARCH-LIKE) =====
    private Task OnSearch(string text)
    {
        searchString = text;
        return dataGrid.ReloadServerData();
    }

    private Task OnDepartmentChanged(string value)
    {
        selectedDepartment = value;
        return dataGrid.ReloadServerData();
    }

    private Task OnMinAgeChanged(int? value)
    {
        minAge = value;
        return dataGrid.ReloadServerData();
    }

    private Task OnMaxAgeChanged(int? value)
    {
        maxAge = value;
        return dataGrid.ReloadServerData();
    }

    private async Task OpenFilterDialog()
    {
        var parameters = new DialogParameters
    {
        { "Search", searchString },
        { "Department", selectedDepartment },
        { "MinAge", minAge },
        { "MaxAge", maxAge },
        { "Departments", Departments }
    };

        var dialog = await DialogService.ShowAsync<EmployeeFilterDialog>(
            "",
            parameters,
            new DialogOptions { MaxWidth = MaxWidth.Small }
        );

        var result = await dialog.Result;

        if (!result.Canceled && result.Data is not null)
        {
            dynamic filter = result.Data;

            searchString = filter.Search;
            selectedDepartment = filter.Department;
            minAge = filter.MinAge;
            maxAge = filter.MaxAge;

            await dataGrid.ReloadServerData();
        }
    }

    private int? loadingId;

    private async Task ToggleStatus(int id)
    {
        loadingId = id;

        await EmployeeService.ToggleStatus(id);
        await dataGrid.ReloadServerData();

        loadingId = null;
    }

    private async Task CreateNewUser()
    {
        var options = new DialogOptions { MaxWidth = MaxWidth.Large };

        var parameters = new DialogParameters<CreateorUpdateEmployee>
        {
            { x => x.Action, UIActionEnum.Insert },
            { x => x.model, new EmployeeViewModel() }
        };

        var dialog = await DialogService.ShowAsync<CreateorUpdateEmployee>(
            "Add Employee", parameters, options);

        var result = await dialog.Result;

        if (result is not null && !result.Canceled)
            await dataGrid.ReloadServerData();
    }

    private async Task UpdateEmployee(CellContext<EmployeeViewModel> employee)
    {
        var employeeview = await EmployeeService.FindEmployee(employee.Item.EmployeeId);
        if (employeeview is null)
        {
            Snackbar.Add("Employee not found!", Severity.Error);
            return;
        }

        var options = new DialogOptions { MaxWidth = MaxWidth.Large };

        var parameters = new DialogParameters<CreateorUpdateEmployee>
        {
            { x => x.Action, UIActionEnum.Update },
            { x => x.model, employeeview },
            { x => x._date, employeeview.DateOfBirth }
        };

        var dialog = await DialogService.ShowAsync<CreateorUpdateEmployee>(
            "Update Employee", parameters, options);

        var result = await dialog.Result;

        if (result is not null && !result.Canceled)
            await dataGrid.ReloadServerData();
    }

    private async Task RemoveEmployee(CellContext<EmployeeViewModel> employee)
    {
        var dialog = await DialogService.ShowAsync<RemoveConfirmationDialog>(
            "Delete Confirmation " + employee.Item.FullName);

        var result = await dialog.Result;

        if (result is not null && !result.Canceled)
        {
            var confirmed = (bool)(result.Data ?? false);
            if (confirmed)
            {
                var deleteResult = await EmployeeService.DeleteEmployee(employee.Item.EmployeeId);
                if (deleteResult)
                {
                    Snackbar.Add("Employee deleted successfully!", Severity.Success);
                    await dataGrid.ReloadServerData();
                }
                else
                {
                    Snackbar.Add("Failed deleting employee.", Severity.Error);
                }
            }
        }
    }
}
